---
title: "All Functions with eelr2012 DatasetXXX need better title"
author: "Stuart Wagenius"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{All Functions with eelr2012 Dataset}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE}
knitr::opts_chunk$set(fig.width=7.2, fig.height=5)
```


# Introduction

This vignette consists of three brief inspections of mating scenes using package `mateable`. A mating scene is a bout of mating where the coordinates of participating individuals are known in three dimensions: space, time, or compatibility. From such information we can quantify mating potential, the capacity for sexual reproduction based on the location, reproductive timing, and compatibility of prospective mates. Mating potential can be quantified for a pair of individuals based on the distance between them, the timing of reproductive activity, and their compatibility. Similarly, mating potential can be defined for an individual within the context of the mating scene or for an entire scene.


Begin by loading the package.

```{r}
library(mateable)
packageDescription("mateable")$Version
```

For any function in `mateable` you can learn more by typing a question mark before the function name, i.e. `?makeScene`. To learn all the functions, type `?mateable` and click index at the bottom of the page.


# A real dataset

In this section we look at flowering during 2012 in a remnant prairie population of *Echinacea angustifolia*, the narrow-leaved purple coneflower. The data frame `eelr2012` is included in the package.

```{r}
str(eelr2012)
```

This data set includes spatial and temporal information on all of 44 plants that flowered in 2012 from the East Elk Lake Road population. Each plant has a tag with a unique number for identification purposes and we listed the count of heads that the plant produced in 2012. These long-lived plants do not produce heads in every year, we removed all plants with zero heads in 2012. The columns firstDay and lastDay indicate the first and last days that each plant produced pollen. Spatial coordinates are in meters.

The first thing to do is convert the data frame to a mating scene object. We have to indicate which columns contain spatial and temporal coordinates. Note that some columns are integer and numeric. Columns firstDay and lastDay are saved in a Date format. `makeScene` can read some character formats. If you want to convert character or POSIX to the Date format, read about the function `as.Date` or install package `lubridate`.

```{r}
eelr <- makeScene(eelr2012, startCol = "firstDay", endCol = "lastDay",
                       xCol = "Ecoord", yCol = "Ncoord", idCol = "tagNo")
```

We can do a lot with this `matingScene` object. Let's start by focusing on the spatial dimension of the mating scene.

## The spatial dimension of the mating scene

We can look at the spatial (s) dimension with a map. Note that we can use standard R graphical parameters to change the looks of the graph.

```{r}
plotScene(eelr, "s")
plotScene(eelr, "s", pch = 1)
```

We can also get the distances between all pairs using function `pairDist`, and then visualize their distribution.

```{r}
ePair <- pairDist(eelr) # matrix of distances
hist(ePair, 40) # visualize histogram
```

We can also calculate the distance from each individual to its nearest neighbors (aka potential mates). Here we visualize the distance to all 3rd nearest neighbors.

```{r}
eKnn <- kNearNeighbors(eelr, 6) # 6 nearest potential mate
str(eKnn)
hist(eKnn[, 3], 40, main = "Distance to 3rd nearest neighbor (m)")
```

Function `matingSummary` calculates many characteristics of the "whole scene." We can save summaries as a new object `eSum` and look at characteristics of the entire mating scene, either by indexing or by name. Here are some spatial summaries.

```{r, collapse = TRUE}
eSum <- matingSummary(eelr)
eSum[c("minX", "minY", "k1")] # by index
# by name
eSum$minX
eSum$minY
eSum$k1 # mean distance to 1st nearest potential mate
```

Distance is a measure of isolation from mates. To characterize mating potential, which is inversely related to distance, we want proximity to mates. For this, we have function `proximity`.

```{r}
eProx <- proximity(eelr, "maxPropSqrd")
eProx$pop
hist(eProx$ind$proximity, 30)

```

Now that we have saved a proximity object, `eProx`, we can visualize it using function `plotPotential`. There are many ways to do it. The defaults show pairwise values of proximity, including a histogram of all pairs, and network diagram of a random subset of 9 individuals and a heat map of all interactions between those same nine.

```{r}
plotPotential(eProx)
```

If we want to focus on a particular subset of plants, then we can define them. Here, we make only a network diagram of these focal plants. Note that by default the size of the individual labels on the network diagram scales with the individual proximity, but this can be turned off. **XXX:** These look wrong. Based on the connecting lines, I think 1509 should be the smallest font size.

```{r}
focalPlants <- c(17217, 17202, 14582, 15114, 7614, 1509, 17002)
plotPotential(eProx, plotType = "net", sub.ids = focalPlants)
```

## The temporal dimension of the mating scene

Now we turn from the spatial dimension of the mating scene to the temporal dimension. We can visualize the coordinates of mating activity in time with a mating schedule. The function `plotScene` works just as well in time as in space, we just need to specify which dimension--use "t" for time.

```{r}
plotScene(eelr, "t")
plotScene(eelr, "t", sub = 'all', drawQuartiles = FALSE, text.cex = 0.5)
```

This figure shows the duration of reproductive period during 2012 for each of the 44 individuals in the population with a horizontal line starting on the date the individual first produced pollen and ending on the date when pollen was last produced. Here the individuals are sorted from bottom to top by their first day. The dots indicate the total number of individuals participating in mating on each day.

Just as we can calculate and visualize the spatial distances between all pairs using function `pairDist`, we can do the same in the temporal dimension with function `overlap`. Function `overlap` makes a matrix of overlapping days for all pairs and we can use a histogram to see the distribution.

```{r}

eOver <- overlap(eelr, compareToSelf = T) # matrix of days overlapping
hist(eOver, 40, main = "Histogram of days overlapping between pair") # visualize histogram
```


We can look at the number of individuals participating in mating every day.
```{r}
eRecep <- receptivityByDay(eelr) # T/F receptive on each day
str(eRecep)
dailyReceptivitySummary <- receptivityByDay(eelr, summary = TRUE)
dailyReceptivitySummary # number of flowering individuals on each day; a vector named by date
plot(as.Date(names(dailyReceptivitySummary)), dailyReceptivitySummary,
     xlab = 'date', ylab = 'count of receptive individuals')

```

Many folks have calculated synchrony many ways for individuals, pairs, and populations. Our function `synchrony` does it all; well, it does a lot. We can specify the many different synchrony measures, with enticing names, such as these (read the help for details): "augspurger", "kempenaers", "sync\_prop", "overlap", "sync\_nn", "simple1", "simple2", and "simple3." Also, we can calculate measures for different subjects: individual, pairs, and the whole scene (population).

Here, for example, we calculate synchrony for all subjects using the overlap method and save it as eSync. Then we show the mean and median population values in red and blue, respectively.

```{r}
eSync <- synchrony(eelr, "overlap")
hist(eSync$ind[, 2], 30)
abline(v = eSync$pop, col ="red", lwd = 2)
abline(v = synchrony(eelr, "overlap", averageType = "median")$pop,
       col = "blue", lwd = 2)
```

Individual overlap indicates the proportion of individuals in the scene that were flowering averaged over all days that the individual participated in mating.

Just like we visualized spatial mating potential we can visualize mating potential in the temporal dimension. Here we emphasize the same focal plants as we did above.

```{r}
plotPotential(eSync, sub.ids = focalPlants)
```


## Time and space together

Function `plotScene` is really handy because it enables us to visualize all dimensions of the mating scene (in this data set we only have two dimensions). In the below figure we also highlight the focal plants we selected above so we can see where and when they participate in mating.

```{r}
plotScene(eelr, c('s','t'), sub = focalPlants, N = 4, text.cex = 0.5)
```

Function `plot3DScene` is also really handy because it enables us to visualize two dimensions of the mating scene in one panel.

```{r}
plot3DScene(eelr)
plot3DScene(eelr, pt.cex = .5, sub = focalPlants, N = 4)

```

Function `matingSummary` calculates many characteristics of the entire mating scene in all three dimensions. Though in this example data set we have only dimensions.

```{r}
eSum <- matingSummary(eelr)
eSum[c("meanSD", "sdSD", "meanDur", "sdDur", "peak")] # index
eSum[c("minX", "minY", "k1")]
eSum$minX # by name
eSum$minY
eSum$k1
```



# A simulated dataset

Along with using data from real populations, we can also simulate scenes. Here we simulate a scene and use the values from the eelr summary as inputs for the simulation parameters.

```{r}
# make scene based off eelr summary information
simScene <- simulateScene(size = nrow(eelr), meanSD = eSum$meanSD,
                          sdSD = eSum$sdSD, meanDur = eSum$meanDur,
                          sdDur = eSum$sdDur, xRange = c(eSum$minX, eSum$maxX),
                          yRange = c(eSum$minY, eSum$maxY))
```

A simulated scene can be treated the exact same as a scene made from real data, meaning all functions work in the same way. In addition, simulated scenes will always have all three dimensions (space, time, and compatibility) so you can examine any aspect of mating potential.

```{r}
sProx <- proximity(simScene, "maxPropSqrd")
sSync <- synchrony(simScene, "augspurger")
sComp <- compatibility(simScene, "si_echinacea")
```

We see here that the spatial and temporal dimensions don't line up perfectly with the original data because they are generated from uniform and normal distributions, respectively.

```{r}
plotScene(simScene)
plot3DScene(simScene, sub = 'random')

plotPotential(sSync)
plotPotential(sProx)
```

Adding compatibility data allows us to see not only how likely mating is between two individuals, but also if it's possible for them to mate at all.

```{r}
plotPotential(sComp, density = FALSE)
plotPotential(sComp,plotType = c('net','heat'), density = FALSE)
```

Plot3DPotential gives us an idea of relationships between different dimensions of potential.

```{r}
plot3DPotential(list(sProx, sSync), subject = "ind")
plot3DPotential(list(sProx, sSync), subject = "ind", sample = 'all')
plot3DPotential(list(sProx, sSync), subject = "ind", sample = 'random')

plot3DPotential(list(sProx, sSync, sComp))
plot3DPotential(list(sProx, sSync, sComp), sub.ids = c(21,4))

```


# Multi-year scenes
```{r, fig.height=7.5}
simScene1 <- simulateScene(size = nrow(eelr), meanSD = eSum$meanSD,
                          sdSD = eSum$sdSD, meanDur = eSum$meanDur,
                          sdDur = eSum$sdDur, xRange = c(eSum$minX, eSum$maxX),
                          yRange = c(eSum$minY, eSum$maxY))
simScene2<- simulateScene(size = nrow(eelr), meanSD = eSum$meanSD,
                          sdSD = eSum$sdSD, meanDur = eSum$meanDur,
                          sdDur = eSum$sdDur, xRange = c(eSum$minX, eSum$maxX),
                          yRange = c(eSum$minY, eSum$maxY))
simScene3 <- simulateScene(size = nrow(eelr), meanSD = eSum$meanSD,
                          sdSD = eSum$sdSD, meanDur = eSum$meanDur,
                          sdDur = eSum$sdDur, xRange = c(eSum$minX, eSum$maxX),
                          yRange = c(eSum$minY, eSum$maxY))

multiYearScene <- list('2012' = simScene1,'2013' = simScene2, '2014' = simScene3)

plotScene(multiYearScene)
plot3DScene(multiYearScene, pt.cex = 1.2)

syncMulti <- synchrony(multiYearScene, method = 'augs')
proxMulti <- proximity(multiYearScene, method = 'maxPropSqrd')
compatMulti <- compatibility(multiYearScene, method = 'si_echinacea')

plotPotential(syncMulti)
plotPotential(proxMulti)

plot3DPotential(list(syncMulti, proxMulti, compatMulti), subject = 'ind')

```


